rules:
  - id: CVE-2023-34342
    metadata:
      author: c0ss4ck9989@gmail.com
      reference:
        - https://9443417.fs1.hubspotusercontent-na1.net/hubfs/9443417/Security%20Advisories/AMI-SA-2023005.pdf
        - https://media.defcon.org/DEF%20CON%2031/DEF%20CON%2031%20presentations/Alex%20Tereshkin%20Adam%20Zabrocki%20-%20Breaking%20BMC%20The%20Forgotten%20Key%20to%20the%20Kingdom.pdf
      confidence: HIGH
    message: >-
      AMI BMC contains a vulnerability in the IPMI handler, where an attacker can upload 
      and download arbitrary files under certain circumstances, which may lead to denial of service, 
      escalation of privileges, information disclosure, or data tampering.
    severity: ERROR
    languages:
      - c
    patterns:
      - pattern: |
          memcpy($D2, $D2_SRC, $D2_SIZE);
          ...
          $FP = GetFilePath(0, $D1);
          ...
          snprintf($D3, $D3_SIZE, "%s/%s", $D1, $D2);
      - pattern-not-inside: |
          memcpy($D2, $D2_SRC, $D2_SIZE);
          ...
          if ($CHECK_PATH($D2)) {
            $FP = GetFilePath(0, $D1);
            ...
            snprintf($D3, $D3_SIZE, "%s/%s", $D1, $D2);
            ...
          }
      - pattern-not-inside: |
          memcpy($D2, $D2_SRC, $D2_SIZE);
          ...
          if (!$CHECK_PATH($D2)) {
            ...
          }
          $FP = GetFilePath(0, $D1);
          ...
          snprintf($D3, $D3_SIZE, "%s/%s", $D1, $D2);
      - metavariable-regex:
          metavariable: $CHECK_PATH
          regex: '.*IsValid.*'